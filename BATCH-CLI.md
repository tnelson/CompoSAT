# CompoSAT Batch CLI

Headless command-line interface for running CompoSAT across multiple `.als` files
and saving results as Alloy XML. 

Tim Nelson (`Tim_Nelson@brown.edu`) and Claude Code (Opus 4.6). This documentation was generated by Claude and edited/refined by Tim. Examples were spot checked by Tim. 


## Usage

```bash
# GUI (unchanged)
java -jar dist/OldCompSAT.jar

# Batch mode: process specific files
java -jar dist/OldCompSAT.jar batch --files a.als b.als --out results/

# Batch mode: scan a directory
java -jar dist/OldCompSAT.jar batch --dir models/ --mode plain --model-limit 10
```

## Flags

| Flag             | Default           | Description                                      |
|------------------|-------------------|--------------------------------------------------|
| `--files`        | *(required, or use --dir)* | `.als` files to process                |
| `--dir`          | none              | Directories to scan for `.als` files             |
| `--mode`         | `coverage`        | `coverage` (CompoSAT ensemble) or `plain` (standard enumeration) |
| `--out`          | `composat-output` | Output directory                                 |
| `--model-limit`  | `-1` (unlimited)  | Max instances per file                           |
| `--time-limit`   | `-1` (unlimited)  | Max time in seconds per file (coverage mode)     |
| `--command`      | all               | Command index to execute (`-1` or omit for all)  |
| `--symmetry`     | `2000`            | Symmetry breaking level (0 to disable)           |

## Output Structure

When a file has multiple commands (the default), results are nested by command name:

```
<out>/
  model1/
    run_SomePred/
      instance_1.xml
      instance_2.xml
    check_SomeAssert/
      instance_1.xml
  model2/
    run_AnotherPred/
      instance_1.xml
```

When `--command N` selects a single command, the command subdirectory is omitted:

```
<out>/
  model1/
    instance_1.xml
    instance_2.xml
```

## Modes

### Coverage mode (`--mode coverage`)

Uses the CompoSAT coverage engine to generate a minimal ensemble of instances
that maximizes provenance coverage. Each instance in the ensemble is written as
a separate XML file.

### Plain mode (`--mode plain`)

Standard Alloy enumeration via `A4Solution.next()`. Generates successive
distinct instances up to `--model-limit`.

## Examples

```bash
# Coverage mode with defaults (all instances, no time limit)
java -jar dist/OldCompSAT.jar batch \
  --files models/grandpa.als \
  --out output/

# Plain mode, 5 instances, specific command
java -jar dist/OldCompSAT.jar batch \
  --files models/grandpa.als \
  --mode plain \
  --model-limit 5 \
  --command 0 \
  --out output/

# Process all .als files in a directory
java -jar dist/OldCompSAT.jar batch \
  --dir models/toys/ \
  --mode plain \
  --model-limit 3 \
  --out output/

# Multiple files and directories
java -jar dist/OldCompSAT.jar batch \
  --files a.als b.als \
  --dir extra-models/ \
  --out output/
```

## Error Handling

Single-file failures do not abort the batch. Errors are reported to stderr,
and a summary is printed at the end showing the count of processed files,
total instances generated, and errors encountered.

## Building

```bash
./build-jar.sh
```

The build script compiles both OldCompSAT and AmalgamKodkod sources, bundles
dependencies and native libraries, and produces `dist/OldCompSAT.jar`.

## Known Limitations

- **Higher-order quantification**: Models with higher-order quantified variables
  (`set X`, `lone X`, `some X` multiplicities) will fail with a skolemization
  error. CompoSAT sets `skolemDepth=-1`, disabling Kodkod's skolemization,
  because the provenance engine (`AmalgamEvalVisitor`) needs to see the original
  quantifier structure to desugar it and track variable bindings. Standard Alloy
  (with `skolemDepth>=0`) handles existential higher-order quantification by
  skolemizing it away, but that would break provenance tracking. Examples in the
  bundled models: `toys/birthday.als` (`lone Date`), `toys/railway.als`
  (`set Train`). Neither model was included in the CompoSAT paper's evaluation.

## Nondeterminism in Provenance Computation

MiniSat's unsat core extraction is nondeterministic across runs: identical inputs
can produce slightly different provenance traces. Fuzz testing `hotel4.als`
(`run {} for 3`) across 4 runs on the same machine yielded:

| Run | Compacted prov traces | Models | Ensemble size |
|-----|----------------------|--------|---------------|
| 1   | 243                  | 168    | 5             |
| 2   | 243                  | 168    | 5             |
| 3   | 244                  | 168    | 6             |
| 4   | 244                  | 168    | 6             |

Model enumeration is fully deterministic (168 every time), but the compacted
provenance count and ensemble size vary slightly. The paper reports 245 skeletons
for this model — within the nondeterministic range we observe. This means small
discrepancies (1-3 traces) between our results and the paper's are expected and
do not indicate bugs.

## Evaluation Results vs. Paper Fig. 4

This tool is reconstructed from an old repository. To check functionality, we 
re-ran the tool on a subset of the evaluation rows in the original CompoSAT paper. 

All runs used `symmetry=2000` to match `EvaluationCLI`. Time-limited runs
used 600s; the paper used 1 hour. Fresh re-run performed 2026-02-09.

| Model | Paper skels | Paper enum | Paper ensm | Our skels | Our enum | Our ensm | Notes |
|-------|------------|------------|------------|-----------|----------|----------|-------|
| grand | 36 | 36 | 2 | 36 | 36 | 2 | Exact match |
| gene | 37 | 768 | 1 | 37 | 768 | 1 | Exact match |
| elect-2 | 179 | 3 | 3 | 179 | 3 | 3 | Exact match |
| fixedm | 13 | 769 | 2 | 13 | 769 | 2 | Exact match |
| hl4 | 245 | 168 | 6 | 245 | 168 | 6 | Exact match |
| simplem | 13 | 5732 | 2 | 12 | 5732 | 2 | Enum exact; skels nondeterministic (12-13) |
| cachem | 12 | — | 1 | 12 | 10736+ | 1 | Skels match; both stopped early |
| abc | 13 | 2 | 1 | 18 | 2 | 1 | Enum exact; skels 18 vs 13 |
| elect-1 | 193 | 2646 | 13 | 181 | 128+ | 9 | Stopped at 600s (paper ran ~35min) |
| media | 639 | 75 | 16/19 | 207 | 5+ | 3 | Both stopped early (paper: 4GB mem limit) |

**Note on grand/gene:** The paper's table has these two rows swapped.

**Note on simplem:** Prov traces nondeterministic: 12 on this run, 13 on a
previous run. Paper reports 13. Model count (5732) is always exact.

**Note on abc:** Model count (2) is exact. Prov traces (18 vs paper's 13) differ
systematically (18 every run, no nondeterminism). Both BatchCLI and EvaluationCLI
produce 18 on the current codebase. All other models with completed enumeration match, 
so it is likely the `abc.als` used in the paper's evaluation differs from what's in 
the revived repository.

**Note on elect-1/media:** Stopped at 600s (paper used 1 hour / 4GB memory limit).
Model counts and prov traces are partial and depend on hardware speed.

**Note on directed_tree.als:** This is also likely different; the version in the 
restored repository uses higher-order (existential) quantification, which isn't 
supported by CompoSAT.

**Note on ring.als:** `appendixA/ring.als` is a textbook exercise stub (empty
`isRing` body) and was NOT part of the paper's evaluation. The "elect" rows in
Fig. 4 refer to ring *election* (`ringElection1.als`, `ringElection2.als`).

**17 additional models missing from repo:** ctrees, ctreesb, digraph, gwh, tclab,
gclab, grade, bempl, other, addr, uml1, uml2, cddiff1, cddiff2, flow, paper.

## Implementation Notes

- Entry point: `JarLauncher` (extracts native libs, sets up `java.library.path`)
  dispatches to `SimpleGUI.main()`, which checks for `batch` arg and dispatches
  to `BatchCLI`.
- `java.awt.headless=true` is set early in `JarLauncher` for batch mode, before
  any AWT classes are loaded.
- Solver options match `EvaluationCLI` (the paper's evaluation harness):
  `MiniSatProverJNI`, `noOverflow=true`, `inferPartialInstance=false`,
  `skolemDepth=-1`, `symmetry=2000`. The paper's footnote says only
  "symmetry-breaking enabled" without specifying the value; `EvaluationCLI`
  hardcodes 2000 (vs Kodkod's default of 20).
